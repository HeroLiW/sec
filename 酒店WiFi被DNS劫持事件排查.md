## **DNS劫持**

DNS劫持是通过篡改DNS（域名系统）解析过程的方式，使得用户的DNS请求被重定向到恶意服务器，从而实现流量拦截、恶意重定向或信息窃取的一种攻击手段。为了理解DNS劫持的原理，我们首先需要理解DNS的基本工作原理，之后才能更好地了解它是如何被攻击者利用的。

------

### **DNS工作原理简介**

DNS是一个将人类可读的域名（如 `www.example.com`）转换为机器可读的IP地址（如 `192.168.1.1`）的系统。它类似于互联网的“电话簿”，每当你访问一个网站时，计算机会查询DNS服务器来获取该网站对应的IP地址，然后通过该IP地址与网站进行通信。

在DNS查询过程中，通常会经历以下步骤：

1. **本地缓存**：计算机首先会检查本地的DNS缓存，看是否已经有该域名的IP地址记录。如果有，直接使用缓存结果。
2. **本地DNS服务器**：如果本地没有缓存结果，计算机会发送DNS查询请求到配置的DNS服务器（通常是ISP提供的DNS服务器）。
3. **递归查询**：如果DNS服务器没有该域名的记录，它会向其他DNS服务器（如根DNS服务器、顶级域DNS服务器等）发送查询请求，直到找到域名对应的IP地址。
4. **返回结果**：一旦DNS服务器找到域名对应的IP地址，它将其返回给客户端，客户端再通过该IP地址与目标服务器建立连接。

------

### **DNS劫持的攻击种类**

DNS劫持利用了DNS解析过程中的几个环节，特别是在DNS查询和响应的过程中篡改数据，具体的原理可以分为以下几种类型：

------

#### **DNS缓存投毒（Cache Poisoning）**

- **原理**：在DNS缓存投毒攻击中，攻击者向DNS服务器的缓存中注入虚假的DNS记录。当用户请求某个域名时，DNS服务器返回被篡改的结果（如将 `www.example.com` 解析到攻击者控制的IP地址），而不是合法的IP地址。

**攻击流程**：

1. 攻击者通过伪造的DNS响应，向DNS服务器发送恶意的DNS记录。
2. 如果攻击者的伪造响应被DNS服务器接受并缓存，那么之后所有查询该域名的请求都将返回恶意的解析结果。
3. 用户通过受污染的DNS服务器得到错误的IP地址，从而访问恶意网站或遭受中间人攻击（MITM）。

**影响**：用户会被重定向到攻击者控制的服务器，导致信息泄露、钓鱼攻击、恶意软件下载等。

------

#### **路由器DNS劫持**

- **原理**：攻击者通过修改路由器的DNS设置，控制所有连接到该路由器的设备使用恶意的DNS服务器进行域名解析。

**攻击流程**：

1. 攻击者访问受害者的路由器管理界面，修改路由器的DNS设置，将DNS服务器指向恶意服务器。
2. 所有通过该路由器连接到网络的设备（如电脑、手机等）都会默认使用恶意的DNS服务器。
3. 用户进行DNS查询时，恶意DNS服务器会将用户的请求解析到钓鱼网站或其他恶意网站上。

**影响**：所有连接到该路由器的设备都可能受到攻击，导致信息泄露、用户账号被盗、恶意软件传播等。

------

#### **中间人DNS劫持（Man-in-the-Middle, MITM）**

- **原理**：在中间人攻击中，攻击者通过在用户和合法DNS服务器之间插入自己，拦截并篡改DNS请求和响应。

**攻击流程**：

1. 用户发起DNS请求时，攻击者拦截并篡改该请求，替换DNS服务器返回的合法IP地址。
2. 攻击者返回的IP地址指向其控制的恶意服务器，用户的流量就被引导到攻击者控制的系统。
3. 这种攻击常常结合其他攻击形式，如HTTP劫持、SSL剥离等，进一步窃取用户信息或执行恶意操作。

**影响**：用户可能访问伪造的、看似合法的网站，导致账号密码泄露、敏感信息被窃取等。

------

#### **DNS重定向劫持**

- **原理**：攻击者通过篡改DNS服务器或本地设备的配置，将所有或某些特定的域名请求重定向到攻击者的服务器，而不是正确的IP地址。

**攻击流程**：

1. 攻击者通过在DNS服务器中注入虚假记录，或者修改受害者设备的DNS设置，将特定域名（如银行网站）解析到攻击者的伪造网站。
2. 用户无意间访问这些伪造网站，从而进入钓鱼页面，或者遭遇恶意软件攻击。

**影响**：用户被恶意重定向，访问虚假的网站，可能造成财务损失、个人信息泄露等。



####  **改变DNS查询流量的中间人攻击（如Wi-Fi劫持）**

- **原理**：攻击者通过拦截公共Wi-Fi网络中的DNS流量，修改DNS查询请求的响应，导致用户访问恶意网站。

**攻击流程**：

1. 攻击者搭建一个伪造的Wi-Fi热点，并等待用户连接。
2. 一旦用户连接，攻击者就可以通过控制该网络中的DNS流量，将用户请求的域名解析到攻击者指定的恶意服务器。
3. 攻击者通过伪造的DNS响应将用户重定向到钓鱼网站，窃取敏感信息。

**影响**：这种攻击通常发生在公共Wi-Fi环境下，用户的敏感数据可能被窃取，设备可能感染恶意软件。

------

### **如何防范DNS劫持**

为了防止DNS劫持，可以采取以下几种措施：

1. **使用DNSSEC**：DNSSEC（DNS安全扩展）通过数字签名来验证DNS响应的完整性，确保返回的DNS数据没有被篡改。
2. **使用加密DNS（DoH/DoT）**：DNS over HTTPS（DoH）和DNS over TLS（DoT）能加密DNS查询流量，防止DNS查询数据被劫持或监听。
3. **更改路由器DNS设置**：避免使用ISP默认的DNS服务器，手动指定安全的DNS服务器（如Google DNS、Cloudflare DNS等）。
4. **使用可信赖的VPN**：通过VPN加密你的所有网络流量，包括DNS查询，避免在不安全的网络环境中遭遇DNS劫持。
5. **定期检查DNS设置**：确保路由器和设备上没有被篡改的DNS设置，及时清理DNS缓存。
6. **使用防火墙和安全软件**：使用反病毒软件和防火墙来检测恶意软件，防止恶意软件通过篡改DNS设置来实施劫持。





## 案例

### 起因

酒店每层都有一个WiFi，我平时连接的都是三楼wifi，有一次连接了四楼WiFi，发现访问视频网站出现以下警告，点击进去显示的博彩网站![image-20241126014818295](C:\Users\admin\Desktop\学习\GitResposity\sec\assets\image-20241126014818295.png)



### 排查

通过`nslookup`查询,发现自动指定的dns地址为`45.14.107.2`

```
C:\Users\admin>nslookup v.qq.com
服务器:  UnKnown
Address:  45.14.107.2

名称:    v.qq.com
Addresses:  221.229.212.170
          180.97.254.94
          43.134.218.199
          119.28.128.130
```

通过window系统的**网络设置->更改适配器选项->详细信息**也可以发现dns服务器地址为45.14.107.2和180.76.76.76。使用在线ip地址查询网站发现此ip地址均为国外ip，初步判定可能存在dns劫持

![image-20241126015332881](C:\Users\admin\Desktop\学习\GitResposity\sec\assets\image-20241126015332881.png)



切换三楼正常WiFi可以对网站进行正常访问，通过使用`ipconfig /flushdns` 命令刷新dns缓存，再使用`nslookup`进行查询，发现正常WiFi的dns地址为`192.168.1.1`，使用在线网站的查询目的地址均为酒店所处市级地址。已经可以判定是路由劫持了。

![image-20241126015844915](C:\Users\admin\Desktop\学习\GitResposity\sec\assets\image-20241126015844915.png)

### 缓解措施

切换四楼异常WiFi，通过window路径**控制面板\网络和 Internet\网络连接** ->属性->Internet协议版本 4（TCP/IPv4）指定该WiFi使用192.168.1.1的DNS服务器地址

![image-20241126020511042](C:\Users\admin\Desktop\学习\GitResposity\sec\assets\image-20241126020511042.png)

可以实现正常访问网站。后续跟酒店老板联系，找到异常路由器，对路由器进行重置。