## 渗透的流程

![图片.png](./assets/1550719703_5c6e1ad700bb6.jpeg)



### 术语

- `EXP（Exploit）`：漏洞利用，一般是完整的漏洞利用代码或程序
- `POC（Proof of Concept）`：漏洞概念验证，一般用于证明漏洞存在，不具有攻击性
- `Shellcode`：获取shell的代码，获取shell是大部分攻击的最终目的
- `Payload`：攻击载荷，一系列具有完整框架性的攻击代码



一般情况，poc是让被攻击程序执行了一段代码证明漏洞存在，

shellcode是你基于poc编写的当被攻击程序执行时会启动shell的代码，

payload是当shell启动后会继续按照预设的攻击框架进行正向或反向的远程连接到攻击者的服务器并且隐匿进程、隐藏流量或有更强攻击性的代码，

而exp是一个按照上述流程编写的完整的攻击程序，任何人运行后都可以直接攻击某个具有该漏洞的主机。

![img](./assets/e2ab6d1c36d2497b87c18aa6ba9e271e.png)



### 前期交互

- 确认范围：测试目标的范围、IP、域名、内外网、测试账户...
- 确认规则：能渗透到什么程度、所需要的时间、能否修改上传、能否提权...
- 确认需求：web应用的漏洞、业务逻辑漏洞、人员权限管理漏洞...





### 信息收集

主动信息收集：与目标有直接接触

被动信息收集：通过第三方进行信息提取

信息收集主要内容：

- 基础信息：ip、网段、域名、子域名、开放端口
- 各端口的应用
- 操作系统
- 中间件
- 所用探测到的东西的版本
- 人员信息：域名注册人员信息、系统管理员信息
- 防护设备：waf、IDS、IDP...





### 漏洞探测

利用上述步骤列出的系统、应用等搜索相应版本的漏洞

利用工具进行漏洞扫描





### 漏洞验证

将上一步中发现的有可能可以成功利用的全部漏洞都验证一遍。结合实际情况，搭建模拟环境进行试验。成功后再应用于目标中。

- 自动化验证：结合自动化扫描工具提供的结果

- 手工验证，根据公开资源进行验证

-  试验验证：自己搭建模拟环境进行验证

- 登陆猜解：有时可以尝试猜解一下登陆口的账号密码等信息

- 业务漏洞验证：如发现业务漏洞，要进行验证

公开资源的利用

- exploit-db/wooyun/

- google hacking

- 渗透代码网站

- 通用、缺省口令

- 厂商的漏洞警告等等





### 信息分析

为下一步实施渗透做准备。

- 精准打击：准备好上一步探测到的漏洞的exp，用来精准打击

- 绕过防御机制：是否有防火墙等设备，如何绕过

- 定制攻击路径：最佳工具路径，根据薄弱入口，高内网权限位置，最终目标

- 绕过检测机制：是否有检测机制，流量监控，杀毒软件，恶意代码检测等（免杀）

- 攻击代码：经过试验得来的代码，包括不限于xss代码，sql注入语句等





### 获取所需

实施攻击：根据前几步的结果，进行攻击

- 获取内部信息：基础设施（网络连接，vpn，路由，拓扑等）

- 进一步渗透：内网入侵，敏感目标

- 持续性存在：一般我们对客户做渗透不需要。rookit，后门，添加管理账号，驻扎手法等

- 清理痕迹：清理相关日志（访问，操作），上传文件等





### 信息整理

-  整理渗透工具：整理渗透过程中用到的代码，poc，exp等

- 整理收集信息：整理渗透过程中收集到的一切信息

- 整理漏洞信息：整理渗透过程中遇到的各种漏洞，各种脆弱位置信息





### 形成报告

- 按需整理：按照之前第一步跟客户确定好的范围，需求来整理资料，并将资料形成报告

- 补充介绍：要对漏洞成因，验证过程和带来危害进行分析

- 修补建议：当然要对所有产生的问题提出合理高效安全的解决办法









## 信息收集如何处理子域名爆破的泛解析问题



### 常见的DNS记录类型

- **A记录**：最常见的DNS记录形式。一个A记录指向一个网站或域名的IP地址。

  A记录的主要应用是用于IP地址的查询。网络浏览器可以通过A记录加载一个使用域名的网页。因此，我们可以在互联网上访问网站，即使我们不知道它们的IP地址。

- **AAAA**记录：与A记录类似，只是它存储的是较新的IPv6地址，而不是IPv4。每一个使用IPv6的互联网网站都需要它

- **CNAME**记录：真实名称记录（英語：Canonical Name Record），即CNAME记录，是域名系统（DNS）的一种记录。 CNAME记录用于将一个域名（同名）映射到另一个域名（真实名称），域名解析服务器遇到CNAME记录会以映射到的目标重新开始查询。 这对于需要在同一个IP地址上运行多个服务的情况来说非常方便。

  假设有下述DNS zone：

  ```
  NAME                    TYPE   VALUE
  --------------------------------------------------
  bar.example.com.        CNAME  foo.example.com.
  foo.example.com.        A      192.0.2.23
  ```

  当要查询*bar.example.com*的A记录时，域名解析器会查到对应的CNAME记录，即*foo.example.com*，随即开始查询该域名的A记录，查到192.0.2.23则返回结果。

- NS记录：NS 代表“域名服务器”，域名服务器记录指示哪个 DNS 服务器对该域具有权威性（即，哪个服务器包含实际 DNS 记录。基本上，NS 记录告诉互联网可从哪里找到域的 IP 地址。一个域通常会有多个 NS 记录，这些记录可指示该域的主要和辅助域名服务器。倘若没有正确配置的 NS 记录，用户将无法加载网站或应用程序。

- MX记录：用于指定负责处理发往收件人域名的邮件服务器。MX记录允许设置一个优先级，当多个邮件服务器可用时，会根据该值决定投递邮件的服务器。[简单邮件传输协议](https://zh.wikipedia.org/wiki/简单邮件传输协议)（SMTP）会根据MX记录的值来决定邮件的路由过程。





### 什么是域名泛解析

域名泛化解析是指：利用通配符* （星号）来做次级域名以实现所有的次级域名均指向同一IP地址。在域名前添加任何子域名，均可访问到所指向的IP地址





### 识别泛解析

- 任意ping一个绝对不存在的子域名

![image-20240521013811111](./assets/image-20240521013811111.png)





### 子域名爆破中解决泛解析的方式

目前最常见的解决方式是IP黑名单的方式

首先访问一个随机的并不存在的域，通过返回的结果判断是否存在泛解析，确定存在泛解析后，（脚本实现）不断的生成随机域名并发送请求，将每次返回的IP和TTL记录下来，直到大部分的IP出现次数都大于两次，则IP黑名单收集完成。而后使用域名字典进行爆破，爆破过程中根据IP黑名单进行过滤，同时比较TTL，在泛解析记录中TTL是相同的，如果TTL不相同，则不是泛解析记录。








## 如何绕过CDN查找真实ip

### 验证是否存在CDN

- 超级ping

  使用各种多地ping服务，查看对应ip地址是否唯一，如果不唯一多半使用了CDN，超级ping网站：

  ```
  http://ping.chinaz.com/
  http://ping.aizhan.com/
  http://ce.cloud.360.cn/
  ```

- nslookup

  使用nslookup进行检测，如果返回域名解析对应多个ip地址多半就是使用了CDN





### 绕过方法

- **DNS历史解析记录**

  查询域名的历史解析记录，可能会找到网站部署CDN前的解析记录，从而获取真实ip

  [iphistory](https://viewdns.info/iphistory/)

  [微步在线](https://x.threatbook.cn/)

  [查询网](https://site.ip138.com/yhuco.xyz/)

  

- **查询子域名**

  很多时候，一些重要的站点会做CDN，而一些子域名站点并没有加入CDN，而且跟主站在同一个C段内，这时候，就可以通过查找子域名来查找网站的真实IP。

  常用的子域名查找方法和工具：

  1、搜索引擎查询：如`Google`、`baidu`、`Bing`等传统搜索引擎，`site:baidu.com inurl:baidu.com`，搜`target.com|公司名字`。

  2、一些在线查询工具，如：[站长工具](http://tool.chinaz.com/subdomain/)

  3、子域名爆破工具：Layer子域名挖掘机

  

- **网站邮件头信息**

  比如说，邮箱注册，邮箱找回密码、RSS邮件订阅等功能场景，通过网站给自己发送邮件，从而让目标主动暴露他们的真实的IP，查看邮件头信息，获取到网站的真实IP

  

- **网络空间安全搜索引擎**

  常见的有钟馗之眼，[shodan](https://www.shodan.io/)，[fofa搜索](https://fofa.so/)。以fofa为例，只需输入：`title:“网站的title关键字”`或者`body：“网站的body特征”`就可以找出fofa收录的有这些关键字的ip域名



- **利用SSL证书寻找真实ip**

  目前[Censys](https://censys.io/ipv4?q=github.comCensys)工具就能实现对整个互联网的扫描，Censys是一款用以搜索联网设备信息的新型搜索引擎，安全专家可以使用它来评估他们实现方案的安全性，而黑客则可以使用它作为前期侦查攻击目标、收集目标信息的强大利器。Censys搜索引擎能够扫描整个互联网，Censys每天都会扫描IPv4地址空间，以搜索所有联网设备并收集相关的信息，并返回一份有关资源（如设备、网站和证书）配置和部署信息的总体报告。

  而攻击者唯一需要做的就是把上面用文字描述的搜索词翻译成实际的搜索查询参数。

  xyz123boot.com证书的搜索查询参数为：`parsed.names：xyz123boot.com`

  只显示有效证书的查询参数为：`tags.raw：trusted`

  攻击者可以在Censys上实现多个参数的组合，这可以通过使用简单的布尔逻辑来完成。

  组合后的搜索参数为：`parsed.names: xyz123boot.com and tags.raw: trusted`



- **国外主机解析域名**

  大部分 CDN 厂商因为各种原因只做了国内的线路，而针对国外的线路可能几乎没有，此时我们使用国外的DNS查询，很可能获取到真实IP



- **利用网站漏洞获取信息**

  SSRF漏洞主动连接









## phpinfo页面你会关注哪些信息

### 如何通过谷歌语法搜索具有该页面的网站

1. **基本搜索查询**：
   
   ```plaintext
   inurl:"phpinfo.php"
   ```
   这个查询会搜索URL中包含“phpinfo.php”的页面。
   
2. **更多高级搜索**：
   ```plaintext
   inurl:"phpinfo.php" intitle:"phpinfo"
   ```
   这个查询进一步过滤，寻找标题中包含“phpinfo”的页面，这通常是典型的phpinfo()输出页面。

3. **结合多个条件**：
   ```plaintext
   inurl:"phpinfo.php" OR inurl:"phpinfo" "PHP Version"
   ```
   这个查询组合了多个条件，查找URL中包含“phpinfo.php”或“phpinfo”，并且页面中包含“PHP Version”文本的页面。这是因为phpinfo()页面通常显示PHP的版本信息。

4. **使用特定文件类型**：
   ```plaintext
   filetype:php inurl:phpinfo
   ```
   这个查询查找文件类型为PHP，并且URL中包含“phpinfo”的页面。

#### 示例查询说明

1. **inurl**：
   - `inurl`操作符用于搜索URL中包含指定字符串的页面。例如`inurl:"phpinfo.php"`会找到所有URL中包含“phpinfo.php”的页面。

2. **intitle**：
   - `intitle`操作符用于搜索网页标题中包含指定字符串的页面。例如`intitle:"phpinfo"`会找到标题中包含“phpinfo”的页面。

3. **OR**：
   - `OR`操作符用于组合多个条件，满足其中一个即可。例如，`inurl:"phpinfo.php" OR inurl:"phpinfo"`会找到URL中包含“phpinfo.php”或“phpinfo”的页面。

4. **filetype**：
   - `filetype`操作符用于搜索特定文件类型的页面。例如`filetype:php`会找到所有PHP文件。





### 敏感信息

`phpinfo()`页面可以提供大量有关服务器和PHP环境的详细信息，这些信息对于渗透测试人员或攻击者来说是非常有用的。以下是一些phpinfo页面上可能包含的敏感信息：

1. **PHP版本信息**：

   - 显示PHP的确切版本号。这可以帮助攻击者确定是否存在针对该版本的已知漏洞。

     

2. **已加载的PHP扩展和模块**：
   - 列出所有已安装和启用的PHP扩展，例如`curl`、`mysqli`、`gd`等。某些扩展可能存在已知漏洞或可被利用。

     

3. **配置信息**：
   - **`register_globals`**：如果开启，可能会导致变量覆盖漏洞。

   - **`allow_url_fopen`** 和 **`allow_url_include`**：如果开启，可能允许远程文件包含攻击。

   - **`display_errors`**：如果开启并设置为`On`，可能会泄露错误消息和路径信息。

   - **`Configuration File(php.ini)Path`**：这一栏表明了php.ini这个php配置文件的位置

   - **`disable_functions`**：表示禁用的函数名

     

4. **环境变量**：

   包括服务器的环境变量，如操作系统类型、服务器软件（如Apache或Nginx版本、服务器IP地址和端口、文档根目录路径等。

   - **环境部分**：`Environment`

   - **Apache环境部分**：`Apache Environment`

     - `SERVER_ADDR`真实ip地址，绕过CDN

   - **服务器环境部分**：`Server Environment`

     

5. **路径信息**：

   绝对路径信息，包括根目录路径、临时目录路径、已加载文件的路径等。这些信息可以帮助攻击者定位和访问敏感文件。

   - 核心配置部分

     ```
     Core
     ```

     - `doc_root` 服务器文档根目录
     - `include_path` 当使用 `include` 或 `require` 等文件包含函数时，PHP 将在这些目录中查找文件。
     - `open_basedir ` 可将用户访问文件的活动范围限制在指定的区域，通常是其家目录的路径
     - `extension path`：php扩展的路径

   - 会话部分

     ```
     session
     ```

     - `session.save_path`

   - 上传部分

     ```
     file_uploads
     ```

     - `upload_tmp_dir`

       

6. **HTTP头信息**：

   包括了请求和响应的HTTP头信息，可以帮助攻击者了解服务器如何处理请求，并可能暴露一些敏感信息。

   - HTTP头信息部分

     ```
     HTTP Headers Information
     ```

     - `HTTP Request Headers`

     - `HTTP Response Headers`

       

7. **数据库配置信息**：

   虽然phpinfo页面不会直接显示数据库用户名和密码，但会显示与数据库连接相关的扩展和配置（如mysqli、PDO等），可以为进一步的数据库攻击提供线索。

   - 数据库扩展部分：如 `mysql`, `mysqli`, `pdo_mysql` 等

     

8. **SSL证书信息**：

   如果启用了SSL，phpinfo页面可能会显示与SSL相关的配置信息，包括证书路径、SSL协议和加密算法。

   - Apache环境部分

     ```
     Apache Environment
     ```

     - SSL相关变量（如果配置了SSL）

       

9. **其他配置信息**：

   - **`open_basedir`**：如果配置不当，可能允许访问未授权的文件。

   - **`session.save_path`**：显示会话文件存储路径，如果路径可写且暴露，可能导致会话劫持。

     

10. **编译选项和命令行选项**：

    显示PHP在编译时使用的选项和命令行选项，可以帮助攻击者了解PHP的构建环境和可利用的功能。

    - PHP变量部分：`PHP Variables`
    - 配置部分：`Configure Command`







## 有没有了解过权限维持

我们可以直接简单的把权限维持理解为我们在目标上安装了一个后门，权限维持的目的是保证自己的权限不会掉,一直控制住目标



### windows权限维持





### Linux权限维持



